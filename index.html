<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scrollable Ladder Climber</title>

  <!-- DotLottie Web Component Loader -->
  <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.5/dist/dotlottie-wc.js" type="module"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui;
      background: #f5f5f5;
    }

    .spacer {
      height: 200vh;
    }

    .ladder-section {
      position: relative;
      height: 100vh;
    }

    .ladder-wrapper {
      position: sticky;
      top: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 40px;
      box-sizing: border-box;
    }

    .ladder-inner {
      position: relative;
      width: 220px;
      height: 520px;
    }

    .ladder-graphic {
      position: absolute;
      inset: 0;
    }

    .ladder-graphic svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .character {
      position: absolute;
      right: -40px;
      bottom: 0;
      width: 110px;
      height: 110px;
      transform: translateY(0);
      pointer-events: none;
    }

    dotlottie-wc {
      position: absolute;
      width: 110px;
      height: 110px;
      opacity: 0;
      transition: opacity 0.15s ease-out;
    }

    .active {
      opacity: 1;
    }
  </style>
</head>

<body>

  <div class="spacer"></div>

  <section class="ladder-section">
    <div class="ladder-wrapper">
      <div class="ladder-inner">

        <!-- LADDER SVG DYNAMICALLY LOADED -->
        <div class="ladder-graphic" id="ladderGraphic"></div>

        <!-- CHARACTER ANIMATIONS -->
        <div class="character" id="character">
          <dotlottie-wc id="idleAnim"
            src="https://lottie.host/13145c5f-8acc-4ea9-8842-58a458ef5553/b1W7KoG3lt.lottie"
            loop autoplay></dotlottie-wc>

          <dotlottie-wc id="climbAnim"
            src="https://lottie.host/97e44afd-2200-44a5-8d60-8db614c54362/cqzrUWVWdo.lottie"
            loop autoplay></dotlottie-wc>

          <dotlottie-wc id="jumpAnim"
            src="https://lottie.host/5fc8dea4-e109-4c3b-813d-afd4da96973b/fdslVCb92l.lottie">
          </dotlottie-wc>
        </div>

      </div>
    </div>
  </section>

  <div class="spacer"></div>

  <script>
    /* ---------------------------------------------
       LOAD LADDER SVG FROM GITHUB RAW URL
    --------------------------------------------- */
    fetch("https://raw.githubusercontent.com/raghav95nanda/SFSScrollTest/refs/heads/main/Ladder%202.svg")
      .then(r => r.text())
      .then(svgText => {
        document.getElementById("ladderGraphic").innerHTML = svgText;
      });


    /* ---------------------------------------------
       SCROLL LOGIC (unchanged from earlier version)
    --------------------------------------------- */
    let state = "idle";
    let climbProgress = 0;
    let currentOffset = 0;
    let ladderHeight = 400;

    const characterEl = document.getElementById("character");
    const idleEl = document.getElementById("idleAnim");
    const climbEl = document.getElementById("climbAnim");
    const jumpEl  = document.getElementById("jumpAnim");

    let lastScroll = window.scrollY;
    let jumpStart = 0;
    const jumpDuration = 2000;
    let jumpFrame = null;

    function setState(newState) {
      if (state === newState) return;
      state = newState;

      idleEl.classList.remove("active");
      climbEl.classList.remove("active");
      jumpEl .classList.remove("active");

      if (newState === "idle") idleEl.classList.add("active");
      if (newState === "climbing") climbEl.classList.add("active");
      if (newState === "jumping") jumpEl.classList.add("active");

      if (newState === "jumping" && typeof jumpEl.seek === "function") {
        jumpEl.seek(0);
      }
    }

    function updatePos() {
      currentOffset = climbProgress * ladderHeight;
      characterEl.style.transform = `translateY(-${currentOffset}px)`;
    }

    function startJump() {
      setState("jumping");

      const startOffset = currentOffset;
      jumpStart = performance.now();

      function tick() {
        if (state !== "jumping") return;

        let t = (performance.now() - jumpStart) / jumpDuration;
        t = Math.min(Math.max(t, 0), 1);

        const y = startOffset * (1 - t);
        characterEl.style.transform = `translateY(-${y}px)`;
        currentOffset = y;

        if (t < 1) {
          jumpFrame = requestAnimationFrame(tick);
        } else {
          climbProgress = 0;
          currentOffset = 0;
          updatePos();
          setState("idle");
        }
      }

      if (jumpFrame) cancelAnimationFrame(jumpFrame);
      jumpFrame = requestAnimationFrame(tick);
    }

    window.addEventListener("scroll", () => {
      const current = window.scrollY;
      const delta = current - lastScroll;
      lastScroll = current;

      if (Math.abs(delta) < 1) return;

      if (state === "jumping") {
        if (jumpFrame) cancelAnimationFrame(jumpFrame);
        climbProgress = ladderHeight ? currentOffset / ladderHeight : 0;
        setState("climbing");
      }

      climbProgress += delta * 0.0006;
      climbProgress = Math.max(0, Math.min(1, climbProgress));

      updatePos();

      if (climbProgress >= 1) {
        startJump();
      } else {
        setState("climbing");
      }

      clearTimeout(window._idleTimeout);
      window._idleTimeout = setTimeout(() => {
        if (state === "climbing" && climbProgress < 1) setState("idle");
      }, 150);
    });

    window.addEventListener("load", () => {
      const rect = document.querySelector(".ladder-inner").getBoundingClientRect();
      ladderHeight = rect.height * 0.8;
      updatePos();
      setState("idle");
    });
  </script>

</body>
</html>
